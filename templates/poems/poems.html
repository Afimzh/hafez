{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ø´Ø¹Ø§Ø±{% endblock %}

{% block content %}
<div class="c-card">
    <h2 class="c-card__title">ğŸ“– Ø§Ø´Ø¹Ø§Ø±</h2>
    <div class="c-card__body">
        <p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø´Ø¹Ø§Ø± Ø­Ø§ÙØ¸ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        
        {% if poem %}
        <div id="poem-card" class="c-card c-card--accent">
            <h3 id="poem-title" class="c-card__title">{{ poem.title }}</h3>
            <div class="c-card__body">
                <p id="poem-text">{{ poem.poem_text|truncatewords:20 }}</p>
                <div class="btn-group u-mt-3">
                    <a id="poem-detail-link" href="{% url 'poem_detail' poem.id %}" class="btn btn--sm btn--outline">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ù…Ù„</a>
                    <button id="next-poem" class="btn btn--sm">Ø´Ø¹Ø± Ø¨Ø¹Ø¯ÛŒ</button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert--info">
            <span class="alert__icon">â„¹ï¸</span>
            <div>
                <p>Ù‡ÛŒÚ† Ø´Ø¹Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("next-poem");
    if (!btn) return;

    // âœ… ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´Ø®Øµ Ú©Ù„Ù…Ù‡
    function truncateWords(str, numWords) {
        if (!str) return "";
        let words = str.split(/\s+/);
        if (words.length > numWords) {
            return words.slice(0, numWords).join(" ") + " ...";
        }
        return str;
    }

    btn.addEventListener("click", function (e) {
        e.preventDefault();
        fetch("{% url 'next_poem_api' %}")  // API Ø´Ø¹Ø± Ø¨Ø¹Ø¯ÛŒ
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("poem-card").innerHTML = `<p>${data.error}</p>`;
                } else {
                    // ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ØªÙ† Ø´Ø¹Ø±
                    document.getElementById("poem-title").textContent = data.title;
                    document.getElementById("poem-text").textContent = truncateWords(data.text, 20);

                    // ğŸ”— Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù† Ù„ÛŒÙ†Ú© "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ù…Ù„"
                    let detailLink = document.getElementById("poem-detail-link");
                    detailLink.href = `/poems/${data.id}/`;  // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø¯Ø± urls.py Ø§Ù„Ú¯ÙˆÛŒ /poems/<id>/ Ø¯Ø§Ø±ÛŒ
                }
            })
            .catch(error => {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¹Ø± Ø¨Ø¹Ø¯ÛŒ:", error);
            });
    });
});
</script>
{% endblock %}
